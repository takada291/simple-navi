<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>simple-navi</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 10px; background-color: #f0f4f8; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { font-size: 1.1rem; margin: 0 0 10px 0; color: #004a99; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .nav-panel { background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center; }
        .nav-target-input { display: flex; gap: 5px; margin-bottom: 10px; }
        .nav-target-input input { width: 50%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; }
        
        .arrow-container { font-size: 3rem; margin: 10px 0; transition: transform 0.3s ease; display: inline-block; }
        .distance-display { font-size: 1.5rem; font-weight: bold; color: #d32f2f; }
        
        .display { background: #333; color: #0f0; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-family: monospace; font-size: 0.85rem; }
        .display div { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .display .val { font-weight: bold; color: #fff; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-bottom: 8px; }
        .btn-gps { background: #007bff; color: white; }
        .btn-map { background: #ff9800; color: white; }
        #map { height: 250px; width: 100%; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid #ccc; }
        #status { font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 5px; }
        
        /* 座標系選択のスタイル調整 */
        .system-box { background: #eee; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h1>簡易ナビ v0.2</h1>

    <div class="nav-panel">
        <div style="font-size: 0.8rem; font-weight: bold; margin-bottom: 5px;">【目標とする直交座標を入力】</div>
        <div class="nav-target-input">
            <input type="number" id="targetX" placeholder="目標 X (北)" step="0.001">
            <input type="number" id="targetY" placeholder="目標 Y (東)" step="0.001">
        </div>
        <div id="navResult">
            <div class="arrow-container" id="arrow">↑</div>
            <div class="distance-display"><span id="distVal">---</span> m</div>
            <div style="font-size: 0.7rem; color: #555;">※スマホの上を”北”にしてください！</div>
        </div>
    </div>

    <div id="status">現在地を取得してください</div>
    <button class="btn-gps" id="btnGps">現在地を更新</button>
    <button class="btn-map" id="btnMap">現在地と目標を地図で表示</button>

    <div id="map"></div>

    <div class="display">
        <div><span>現在 X (北):</span> <span class="val" id="posX">---</span> m</div>
        <div><span>現在 Y (東):</span> <span class="val" id="posY">---</span> m</div>
        <div style="font-size: 0.7rem; color: #aaa; margin-top:5px;">系: <span id="sysDisplay">6</span>系 / 緯度:<span id="lat">--</span> 経度:<span id="lon">--</span></div>
    </div>

    <div class="system-box">
        座標系の選択:
        <select id="systemSelect">
            </select>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 定数・変数 ---
    const SYSTEM_ORIGINS = {
        1:[33,129.5], 2:[33,131], 3:[36,132.166666666], 4:[33,133.5], 5:[33,134.333333333],
        6:[36,136], 7:[36,137.166666666], 8:[36,138.5], 9:[36,139.833333333], 10:[40,140.833333333],
        11:[40,142.833333333], 12:[44,142.25], 13:[44,143.333333333], 14:[44,145.833333333],
        15:[26,124], 16:[26,127], 17:[26,131], 18:[20,136], 19:[26,154]
    };

    let currentRaw = null;
    let map = null;
    let currentMarker = null; // 現在地ピン
    let targetMarker = null;  // 目標地ピン

    // --- 座標系セレクトボックスの生成 ---
    const sysSelect = document.getElementById('systemSelect');
    for (let i = 1; i <= 19; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.innerText = `第 ${i} 系 ${i===6 ? '(デフォルト)' : ''}`;
        if (i === 6) opt.selected = true;
        sysSelect.appendChild(opt);
    }

    // 逆変換（平面直角座標 -> 緯度経度）目標ピン表示用
    function reverseConvert(x, y, sysId) {
        const origin = SYSTEM_ORIGINS[sysId];
        const phi0 = origin[0] * Math.PI / 180;
        const lam0 = origin[1] * Math.PI / 180;
        const a = 6378137.0, f = 1/298.257222101, m0 = 0.9999;
        const e2 = f*(2-f), n = f/(2-f);
        const ap = (a/(1+n))*(1 + (n**2)/4 + (n**4)/64);
        const s0 = ((p) => {
            const A = 1 + (3/4)*e2 + (45/64)*(e2**2) + (175/256)*(e2**3);
            const B = (3/4)*e2 + (15/16)*(e2**2) + (525/512)*(e2**3);
            const C = (15/64)*(e2**2) + (105/256)*(e2**3);
            return a*(1-e2)*(A*p - (B/2)*Math.sin(2*p) + (C/4)*Math.sin(4*p));
        })(phi0);

        const xi = (x + m0 * s0) / (m0 * ap);
        const eta = y / (m0 * ap);
        const delta = [0, (1/2)*n-(2/3)*(n**2)+(37/96)*(n**3), (1/48)*(n**2)+(1/15)*(n**3), (17/480)*(n**3)];
        let xip = xi, etap = eta;
        for(let j=1; j<=3; j++) {
            xip -= delta[j] * Math.sin(2*j*xi) * Math.cosh(2*j*eta);
            etap -= delta[j] * Math.cos(2*j*xi) * Math.sinh(2*j*eta);
        }
        const chi = Math.asin(Math.sin(xip) / Math.cosh(etap));
        const phi = chi + ( (e2/2) + (5/24)*(e2**2) + (e2**3)/12 )*Math.sin(2*chi) 
                    + ( (7/48)*(e2**2) + (29/240)*(e2**3) )*Math.sin(4*chi) 
                    + ( (7/120)*(e2**3) )*Math.sin(6*chi);
        const lam = lam0 + Math.atan(Math.sinh(etap) / Math.cos(xip));
        return [phi * 180 / Math.PI, lam * 180 / Math.PI];
    }

    // 順変換（緯度経度 -> 平面直角座標）現在地表示用
    function convert(lat, lon, sysId) {
        const origin = SYSTEM_ORIGINS[sysId];
        const phi0 = origin[0] * Math.PI / 180;
        const lam0 = origin[1] * Math.PI / 180;
        const phi = lat * Math.PI / 180;
        const lam = lon * Math.PI / 180;
        const a = 6378137.0, f = 1/298.257222101, m0 = 0.9999;
        const e2 = f*(2-f), n = f/(2-f);
        const ap = (a/(1+n))*(1 + (n**2)/4 + (n**4)/64);
        const beta = [0, (1/2)*n-(2/3)*(n**2)+(5/16)*(n**3), (13/48)*(n**2)-(3/5)*(n**3), (61/240)*(n**3)];
        const dl = lam - lam0;
        const t = Math.sinh(Math.atanh(Math.sin(phi)) - (2*Math.sqrt(n)/(1+n))*Math.atanh((2*Math.sqrt(n)/(1+n))*Math.sin(phi)));
        const xip = Math.atan(t / Math.cos(dl)), etap = Math.atanh(Math.sin(dl) / Math.sqrt(1 + t**2));
        let xi = xip, eta = etap;
        for(let j=1; j<=3; j++) {
            xi += beta[j]*Math.sin(2*j*xip)*Math.cosh(2*j*etap);
            eta += beta[j]*Math.cos(2*j*xip)*Math.sinh(2*j*etap);
        }
        const s = (p) => {
            const A = 1 + (3/4)*e2 + (45/64)*(e2**2) + (175/256)*(e2**3);
            const B = (3/4)*e2 + (15/16)*(e2**2) + (525/512)*(e2**3);
            const C = (15/64)*(e2**2) + (105/256)*(e2**3);
            return a*(1-e2)*(A*p - (B/2)*Math.sin(2*p) + (C/4)*Math.sin(4*p));
        };
        return { x: m0*ap*xi - m0*s(phi0), y: m0*ap*eta };
    }

    function updateNavigation() {
        const tx = parseFloat(document.getElementById('targetX').value);
        const ty = parseFloat(document.getElementById('targetY').value);
        if (isNaN(tx) || isNaN(ty) || !currentRaw || !currentRaw.x) return;

        const dx = tx - currentRaw.x;
        const dy = ty - currentRaw.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        document.getElementById('distVal').innerText = dist.toFixed(1);

        const angleRad = Math.atan2(dy, dx); 
        const angleDeg = angleRad * 180 / Math.PI;
        document.getElementById('arrow').style.transform = `rotate(${angleDeg}deg)`;
    }

    function getLocation() {
        const status = document.getElementById('status');
        const sysId = document.getElementById('systemSelect').value;
        status.innerText = "GPS取得中...";
        navigator.geolocation.getCurrentPosition(
            pos => {
                status.innerText = "更新完了";
                currentRaw = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                const res = convert(currentRaw.lat, currentRaw.lon, sysId);
                currentRaw.x = res.x; currentRaw.y = res.y;

                document.getElementById('lat').innerText = currentRaw.lat.toFixed(5);
                document.getElementById('lon').innerText = currentRaw.lon.toFixed(5);
                document.getElementById('posX').innerText = res.x.toFixed(3);
                document.getElementById('posY').innerText = res.y.toFixed(3);
                document.getElementById('sysDisplay').innerText = sysId;
                
                updateNavigation();
                if(map) showMap();
            },
            err => { status.innerText = "エラー: " + err.message; },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }

    function showMap() {
        if (!currentRaw) return alert("位置情報を取得してください");
        const mapDiv = document.getElementById('map');
        mapDiv.style.display = 'block';
        const sysId = document.getElementById('systemSelect').value;
        
        // 目標地の緯度経度を算出
        const tx = parseFloat(document.getElementById('targetX').value);
        const ty = parseFloat(document.getElementById('targetY').value);
        let targetLatLng = null;
        if(!isNaN(tx) && !isNaN(ty)) {
            targetLatLng = reverseConvert(tx, ty, sysId);
        }

        if (!map) {
            map = L.map('map');
            L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
                attribution: "地理院地図"
            }).addTo(map);
            currentMarker = L.marker([currentRaw.lat, currentRaw.lon], {title: "現在地"}).addTo(map).bindPopup("現在地");
        } else {
            currentMarker.setLatLng([currentRaw.lat, currentRaw.lon]);
        }

        // 目標ピンの処理
        if (targetLatLng) {
            if (!targetMarker) {
                targetMarker = L.marker(targetLatLng, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup("目標地点");
            } else {
                targetMarker.setLatLng(targetLatLng);
            }
            // 両方のピンが見えるように調整
            const group = new L.featureGroup([currentMarker, targetMarker]);
            map.fitBounds(group.getBounds().pad(0.2)); 
        } else {
            map.setView([currentRaw.lat, currentRaw.lon], 18);
        }
        
        setTimeout(() => map.invalidateSize(), 100);
    }

    document.getElementById('btnGps').addEventListener('click', getLocation);
    document.getElementById('btnMap').addEventListener('click', showMap);
    document.getElementById('targetX').addEventListener('input', updateNavigation);
    document.getElementById('targetY').addEventListener('input', updateNavigation);
    document.getElementById('systemSelect').addEventListener('change', () => {
        if(currentRaw) getLocation();
    });
</script>
</body>
</html>
